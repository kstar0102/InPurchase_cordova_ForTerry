var store={};(function(){"use strict";store.FREE_SUBSCRIPTION="free subscription";store.PAID_SUBSCRIPTION="paid subscription";store.CONSUMABLE="consumable";store.NON_CONSUMABLE="non consumable";var ERROR_CODES_BASE=4983497;store.ERR_SETUP=ERROR_CODES_BASE+1;store.ERR_LOAD=ERROR_CODES_BASE+2;store.ERR_PURCHASE=ERROR_CODES_BASE+3;store.ERR_LOAD_RECEIPTS=ERROR_CODES_BASE+4;store.ERR_CLIENT_INVALID=ERROR_CODES_BASE+5;store.ERR_PAYMENT_CANCELLED=ERROR_CODES_BASE+6;store.ERR_PAYMENT_INVALID=ERROR_CODES_BASE+7;store.ERR_PAYMENT_NOT_ALLOWED=ERROR_CODES_BASE+8;store.ERR_UNKNOWN=ERROR_CODES_BASE+10;store.ERR_REFRESH_RECEIPTS=ERROR_CODES_BASE+11;store.ERR_INVALID_PRODUCT_ID=ERROR_CODES_BASE+12}).call(this);(function(){"use strict";store.Product=function(options){if(!options)options={};this.id=options.id||null;this.alias=options.alias||options.id||null;this.price=options.price||null;this.currency=options.currency||null;this.title=options.title||options.localizedTitle||null;this.description=options.description||options.localizedDescription||null;this.localizedTitle=options.localizedTitle||options.title||null;this.localizedDescription=options.localizedDescription||options.description||null;this.localizedPrice=options.localizedPrice||null;this.loaded=options.loaded;this.valid=options.valid}}).call(this);(function(){"use strict";store.Error=function(options){if(!options)options={};this.code=options.code||store.ERR_UNKNOWN;this.message=options.message||"unknown error"};store.error=function(cb){store.error.callbacks.push(cb)}}).call(this);store.registerProducts=function(products){for(var i=0;i<products.length;++i){var p=new store.Product(products[i]);if(!p.alias)p.alias=p.id;this.products.push(p)}};(function(){"use strict";store.when=function(query,once){return{loaded:function(cb){store._queries.callbacks.add(query,"loaded",cb,once);return this},approved:function(cb){store._queries.callbacks.add(query,"approved",cb,once);return this},rejected:function(cb){store._queries.callbacks.add(query,"rejected",cb,once);return this},updated:function(cb){store._queries.callbacks.add(query,"updated",cb,once);return this},cancelled:function(cb){store._queries.callbacks.add(query,"cancelled",cb,once);return this},error:function(cb){store._queries.callbacks.add(query,"error",cb,once);return this}}};store.once=function(query){return store.when(query,true)}}).call(this);(function(){"use strict";store.ask=function(pid){var that=this;var p=store.products.byId[pid]||store.products.byAlias[pid];if(!p){p=new store.Product({id:pid,loaded:true,valid:false})}var skip=false;return{then:function(cb){if(p.loaded&&p.valid){skip=true;cb(p)}else that.once(pid).loaded(function(p){if(skip)return;if(p.valid){skip=true;cb(p)}});return this},error:function(cb){if(p.loaded&&!p.valid){skip=true;cb(new store.Error({code:store.ERR_INVALID_PRODUCT_ID,message:"Invalid product"}),p)}else{that.once(pid).error(function(err,p){if(skip)return;if(err.code===store.ERR_LOAD){skip=true;cb(err,p)}});that.once(pid).loaded(function(p){if(skip)return;if(!p.valid){skip=true;cb(new store.Error({code:store.ERR_INVALID_PRODUCT_ID,message:"Invalid product"}),p)}})}return this}}}}).call(this);(function(){var isReady=false;var callbacks=[];store.ready=function(cb){if(cb===true){if(isReady)return this;isReady=true;for(var i=0;i<callbacks.length;++i)callbacks[i].call(this);callbacks=[]}else if(cb){if(isReady){cb();return this}else{callbacks.push(cb)}}else{return isReady}return this}})();store.products=[];store.products.push=function(p){Array.prototype.push.call(this,p);this.byId[p.id]=p;this.byAlias[p.alias]=p};store.products.byId={};store.products.byAlias={};(function(){"use strict";store._queries={uniqueQuery:function(string){if(!string)return"";var query="";var tokens=string.split(" ");for(var i=0;i<tokens.length;++i){var token=tokens[i];if(token!=="order"&&token!=="product"){if(query!=="")query+=" ";query+=tokens[i]}}return query},callbacks:{byQuery:{},add:function(query,action,cb,once){var fullQuery=store._queries.uniqueQuery(query?query+" "+action:action);if(this.byQuery[fullQuery])this.byQuery[fullQuery].push({cb:cb,once:once});else this.byQuery[fullQuery]=[{cb:cb,once:once}]}},triggerWhenProduct:function(product,action,args){var queries=[];if(product&&product.id)queries.push(product.id+" "+action);if(product&&product.alias)queries.push(product.alias+" "+action);if(product&&product.type)queries.push(product.type+" "+action);if(product&&product.type&&(product.type===store.FREE_SUBSCRIPTION||product.type===store.PAID_SUBSCRIPTION))queries.push("subscription "+action);if(product&&product.valid===true)queries.push("valid "+action);if(product&&product.valid===false)queries.push("invalid "+action);queries.push(action);var isNotOnce=function(cb){return!cb.once};var i;for(i=0;i<queries.length;++i){var q=queries[i];var cbs=store._queries.callbacks.byQuery[q];if(cbs){for(var j=0;j<cbs.length;++j){cbs[j].cb.apply(store,args)}store._queries.callbacks.byQuery[q]=cbs.filter(isNotOnce)}}}}}).call(this);(function(){"use strict";store.error.callbacks=[];store.error.callbacks.trigger=function(error){for(var i=0;i<this.length;++i)this[i].call(store,error)};store.error.callbacks.reset=function(){while(this.length>0)this.shift()}}).call(this);store.order=function(product){};store.refresh=function(query){};module.exports=store;